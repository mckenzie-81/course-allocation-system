package com.courseallocation.course_allocation.service;

// Temporarily disabled - needs update for new entity structure
// import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.courseallocation.course_allocation.config.JwtTokenProvider;
import com.courseallocation.course_allocation.dto.LoginRequest;
import com.courseallocation.course_allocation.dto.LoginResponse;
import com.courseallocation.course_allocation.model.Student;
import com.courseallocation.course_allocation.repository.StudentRepository;

import lombok.RequiredArgsConstructor;

// @Service - Temporarily disabled
@RequiredArgsConstructor
@Transactional
public class AuthenticationService {

    private final StudentRepository studentRepository;
    private final JwtTokenProvider jwtTokenProvider;

    public LoginResponse login(LoginRequest request) {
        Student student = studentRepository.findByStudentId(request.getStudentId())
                .orElseThrow(() -> new RuntimeException("Invalid student ID or PIN"));

        if (!student.getPin().equals(request.getPin())) {
            throw new RuntimeException("Invalid student ID or PIN");
        }

        String token = jwtTokenProvider.generateToken(student.getId(), student.getStudentId());

        return new LoginResponse(
                student.getId(),
                student.getStudentId(),
                student.getFirstName(),
                student.getLastName(),
                student.getEmail(),
                student.getDepartment(),
                student.getYear(),
                token
        );
    }

    public Student getStudentByToken(String token) {
        if (!jwtTokenProvider.validateToken(token)) {
            throw new RuntimeException("Invalid or expired token");
        }
        Long studentId = jwtTokenProvider.getStudentIdFromToken(token);
        return studentRepository.findById(studentId)
                .orElseThrow(() -> new RuntimeException("Student not found"));
    }
}

